<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fast Implementation of a Key-Value Store • fastmap</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Fast Implementation of a Key-Value Store">
<meta property="og:description" content="Fast implementation of a key-value store. Environments are commonly
    used as key-value stores, but every time a new key is used, it is added to
    R's global symbol table, causing a small amount of memory leakage. This can
    be problematic in cases where many different keys are used. Fastmap avoids
    this memory leak issue by implementing the map using data structures in C++.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">fastmap</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/fastmap">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="fastmap" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#fastmap" class="anchor"></a>fastmap</h1></div>
<!-- badges: start -->

<p><strong>fastmap</strong> is a package that implements <em>maps</em> – that is, key-value stores – in R.</p>
<p>The usual way of doing this in R is to use environments. However, this method is problematic when using a large set of keys or randomly-generated keys, because each time you use a key or even check for the existence of a key using <code><a href="https://rdrr.io/r/base/exists.html">exists()</a></code>, that key is interned as a symbol and stored in the R symbol table, which is never garbage-collected. This means that every time you use a new key – whether it is to store an object or just check whether the key exists in the environment, R leaks a little memory. If you have a relatively small, fixed set of keys, or if your R process is a short-running process, this may not be a problem. But if, for example, you have a long-running R process that uses random keys, then the memory leakage can cause a noticeable increase in memory usage. Also, when R’s symbol table is large, garbage collection events, which occur regularly, take more time, reducing R’s performance in general. (See the <em>Memory leak examples</em> section of this document for more information.)</p>
<p><strong>fastmap</strong> solves this problem by storing the keys as C++ <code>std::string</code> objects, and so it does not use the R symbol table at all. The values are stored in a list so that R knows not to garbage-collect them. In C++, fastmap uses a <a href="https://github.com/Tessil/hopscotch-map/"><code>tsl::hopscotch_map</code></a> (which is similar to <code>std::unordered_map</code>) to map from the keys to indices in the list of values.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"fastmap"</span>)</a></code></pre></div>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(fastmap)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co"># Create a map</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">m &lt;-<span class="st"> </span><span class="kw"><a href="reference/fastmap.html">fastmap</a></span>()</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co"># Set some key-value pairs</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">m<span class="op">$</span><span class="kw">set</span>(<span class="st">"x"</span>, <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">m<span class="op">$</span><span class="kw">set</span>(<span class="st">"letters"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>))</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">m<span class="op">$</span><span class="kw">mset</span>(<span class="dt">numbers =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>), <span class="dt">nothing =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co"># Get values using keys</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">m<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co">#&gt; [1] 100</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">m<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"numbers"</span>)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">#&gt; [1] 10 20 30</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">m<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/get.html">mget</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"letters"</span>, <span class="st">"numbers"</span>))</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">#&gt; $letters</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">#&gt; [1] "a" "b" "c"</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#&gt; $numbers</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co">#&gt; [1] 10 20 30</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co"># Missing keys return NULL by default, but this can be customized</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">m<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"xyz"</span>)</a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26"></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="co"># Check for existence of keys</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">m<span class="op">$</span><span class="kw">has</span>(<span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">m<span class="op">$</span><span class="kw">has</span>(<span class="st">"nothing"</span>)</a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">m<span class="op">$</span><span class="kw">has</span>(<span class="st">"xyz"</span>)</a>
<a class="sourceLine" id="cb2-33" data-line-number="33"><span class="co">#&gt; [1] FALSE</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34"></a>
<a class="sourceLine" id="cb2-35" data-line-number="35"><span class="co"># Remove one or more items</span></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">m<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/rm.html">remove</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"letters"</span>, <span class="st">"x"</span>))</a>
<a class="sourceLine" id="cb2-37" data-line-number="37"></a>
<a class="sourceLine" id="cb2-38" data-line-number="38"><span class="co"># Return number of items</span></a>
<a class="sourceLine" id="cb2-39" data-line-number="39">m<span class="op">$</span><span class="kw">size</span>()</a>
<a class="sourceLine" id="cb2-40" data-line-number="40"><span class="co">#&gt; [1] 2</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41"></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"><span class="co"># Get all keys</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">m<span class="op">$</span><span class="kw">keys</span>()</a>
<a class="sourceLine" id="cb2-44" data-line-number="44"><span class="co">#&gt; [1] "nothing" "numbers"</span></a>
<a class="sourceLine" id="cb2-45" data-line-number="45"></a>
<a class="sourceLine" id="cb2-46" data-line-number="46"><span class="co"># Return named list that represents all key-value pairs</span></a>
<a class="sourceLine" id="cb2-47" data-line-number="47"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(m<span class="op">$</span><span class="kw">as_list</span>())</a>
<a class="sourceLine" id="cb2-48" data-line-number="48"><span class="co">#&gt; List of 3</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49"><span class="co">#&gt;  $ nothing: NULL</span></a>
<a class="sourceLine" id="cb2-50" data-line-number="50"><span class="co">#&gt;  $ numbers: num [1:3] 10 20 30</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51"></a>
<a class="sourceLine" id="cb2-52" data-line-number="52"><span class="co"># Clear the map</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53">m<span class="op">$</span><span class="kw">reset</span>()</a></code></pre></div>
<p>By default, <code><a href="https://rdrr.io/r/base/get.html">get()</a></code> returns <code>NULL</code> for keys that aren’t present. You can instead specify a sentinel value to return for missing keys, either when the fastmap is created, or when <code><a href="https://rdrr.io/r/base/get.html">get()</a></code> is called. For example, you can return a <code><a href="reference/key_missing.html">key_missing()</a></code> object to represent missing values:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Specify missing value when get() is called</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">m &lt;-<span class="st"> </span><span class="kw"><a href="reference/fastmap.html">fastmap</a></span>()</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">m<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"x"</span>, <span class="dt">missing =</span> <span class="kw"><a href="reference/key_missing.html">key_missing</a></span>())</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; &lt;Key Missing&gt;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co"># Specify the default missing value</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">m &lt;-<span class="st"> </span><span class="kw"><a href="reference/fastmap.html">fastmap</a></span>(<span class="dt">missing_default =</span> <span class="kw"><a href="reference/key_missing.html">key_missing</a></span>())</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">m<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; &lt;Key Missing&gt;</span></a></code></pre></div>
</div>
<div id="notes" class="section level2">
<h2 class="hasAnchor">
<a href="#notes" class="anchor"></a>Notes</h2>
<div id="key-ordering" class="section level3">
<h3 class="hasAnchor">
<a href="#key-ordering" class="anchor"></a>Key ordering</h3>
<p>When you call <code>m$keys()</code> or <code>m$as_list()</code>, the items are returned in an arbitrary order. Keep in mind that there is no guarantee that the order will be the same across platforms, or across different builds of fastmap.</p>
<p>If you want to guarantee a particular order, you can call <code>m$keys(sort=TRUE)</code> or <code>m$as_list(sort=TRUE)</code>. The result will be a locale-independent sorting of the keys by their Unicode code point values. For example, <code>é</code> (Unicode code point 233) comes after <code>z</code> (122). If you want the keys to be sorted a different way, you will need to sort them yourself.</p>
</div>
<div id="serialization" class="section level3">
<h3 class="hasAnchor">
<a href="#serialization" class="anchor"></a>Serialization</h3>
<p>A fastmap object can be serialized (or saved) in one R session and deserialized (or loaded) in another. For performance, the data structure that tracks the mapping between keys and values is implemented in C++, and this data structure will not be serialized, but fastmap also keeps a copy of the same information in an ordinary R vector, which will be serialized. After a fastmap object is deserialized, the C++ data structure will not exist, but the first time any method on the fastmap is called, the C++ data structure will be rebuilt using information from the R vector.</p>
<p>The vector is much slower for lookups, and so it is used only for restoring the C++ data structure after a fastmap object is deserialized or loaded.</p>
</div>
<div id="key-encoding" class="section level3">
<h3 class="hasAnchor">
<a href="#key-encoding" class="anchor"></a>Key encoding</h3>
<p>Unlike with environments, the keys in a fastmap are always encoded as UTF-8, so if you call <code>m$set()</code> with two different strings that have the same Unicode values but have different encodings, the second call will overwrite the first value. If you call <code>m$keys()</code>, it will return UTF-8 encoded strings, and similarly, <code>m$mget()</code> and <code>m$as_list()</code> will return lists with names that have UTF-8 encoding.</p>
</div>
<div id="testing-for-equality" class="section level3">
<h3 class="hasAnchor">
<a href="#testing-for-equality" class="anchor"></a>Testing for equality</h3>
<p>The base R functions <code><a href="https://rdrr.io/r/base/identical.html">identical()</a></code> and <code><a href="https://rdrr.io/r/base/all.equal.html">all.equal()</a></code> are commonly used to test two objects for equality, but they will not work correctly for fastmap objects. <code><a href="https://rdrr.io/r/base/identical.html">identical()</a></code> will always report <code>FALSE</code> for two distinct fastmap objects, even if they have the same contents, while <code><a href="https://rdrr.io/r/base/all.equal.html">all.equal()</a></code> will always report <code>TRUE</code> for two fastmap objects.</p>
<p>To test whether two fastmap objects have the same contents, compare the results of <code>$as_list(sort=TRUE)</code> for both of the objects. For example:</p>
<pre><code><a href="https://rdrr.io/r/base/identical.html">identical(a$as_list(sort = TRUE), b$as_list(sort = TRUE))
# or
all.equal(a$as_list(sort = TRUE), b$as_list(sort = TRUE))</a></code></pre>
<p>These comparisons are subject to the technical details of how <code><a href="https://rdrr.io/r/base/identical.html">identical()</a></code> and <code><a href="https://rdrr.io/r/base/all.equal.html">all.equal()</a></code> treat named lists.</p>
</div>
</div>
<div id="memory-leak-examples" class="section level2">
<h2 class="hasAnchor">
<a href="#memory-leak-examples" class="anchor"></a>Memory leak examples</h2>
<p>This example shows how using a regular R environment leaks memory, even when simply checking for the existence of a key.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(pryr)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/gc.html">gc</a></span>()</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">start_mem &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/pryr/man/mem_used.html">mem_used</a></span>()</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">start_time &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>())</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>) {</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(i, <span class="st">": "</span>, <span class="dt">sep =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/pryr/man/mem_used.html">mem_used</a></span>())</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  e &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span>(<span class="dt">parent =</span> <span class="kw"><a href="https://rdrr.io/r/base/environment.html">emptyenv</a></span>())</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10000</span>) {</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">    <span class="co"># Generate random key</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    <span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(x, <span class="dt">envir =</span> e, <span class="dt">inherits =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  <span class="kw"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(e, x)</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">end_time &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>())</a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/base/gc.html">gc</a></span>()</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">end_mem &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/pryr/man/mem_used.html">mem_used</a></span>()</a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Elapsed time:"</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(end_time <span class="op">-</span><span class="st"> </span>start_time, <span class="dv">1</span>), <span class="st">"seconds</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Memory leaked:"</span>, end_mem <span class="op">-</span><span class="st"> </span>start_mem, <span class="st">"bytes</span><span class="ch">\n</span><span class="st">"</span>)</a></code></pre></div>
<p>The output looks something like this:</p>
<pre><code>1: 57.9 MB
2: 59.9 MB
3: 61.9 MB
4: 64.4 MB
5: 66.4 MB
6: 68.4 MB
7: 70.4 MB
8: 72.4 MB
Elapsed time: 1.1 seconds
Memory leaked: 16243656 bytes</code></pre>
<p>The elapsed time gets progressively slower as the R symbol table gets larger and larger. After running the above code repeatedly, the elapsed time for the fifth run is 3.1 seconds. If you profile the code with <a href="https://rstudio.github.io/profvis/">profvis</a>, you can see that most of the slowdown is not with environment operations themselves, but with garbage collection events. This slowdown appears to affect all GC events, even when no environment-related operations are performed between one GC and the next.</p>
<p>For comparison, this example with fastmap does the same thing.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(fastmap)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(pryr)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/gc.html">gc</a></span>()</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">start_mem &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/pryr/man/mem_used.html">mem_used</a></span>()</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">start_time &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>())</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>) {</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(i, <span class="st">": "</span>, <span class="dt">sep =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/pryr/man/mem_used.html">mem_used</a></span>())</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  m &lt;-<span class="st"> </span><span class="kw"><a href="reference/fastmap.html">fastmap</a></span>()</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10000</span>) {</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">    x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">    m<span class="op">$</span><span class="kw">has</span>(x)</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  <span class="kw"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(m, x)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">end_time &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>())</a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/base/gc.html">gc</a></span>()</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">end_mem &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/pryr/man/mem_used.html">mem_used</a></span>()</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Elapsed time:"</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(end_time <span class="op">-</span><span class="st"> </span>start_time, <span class="dv">1</span>), <span class="st">"seconds</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"Memory leaked:"</span>, end_mem <span class="op">-</span><span class="st"> </span>start_mem, <span class="st">"bytes</span><span class="ch">\n</span><span class="st">"</span>)</a></code></pre></div>
<p>The output in a new R session looks something like this (note that this is from the second run of the code above – for the first run, there is an increase in memory used, but it is probably related to code being run for the first time in the R session):</p>
<pre><code>1: 42.3 MB
2: 42.3 MB
3: 42.3 MB
4: 42.3 MB
5: 42.3 MB
6: 42.3 MB
7: 42.3 MB
8: 42.3 MB
Elapsed time: 0.9 seconds
Memory leaked: 0 bytes</code></pre>
<p>It does not leak memory, and it does not slow down if you run it repeatedly. After running it ten times, it still takes 0.9 seconds, and leaks no memory.</p>
<p>The simple tests above simply check for the existence of keys, but with setting values, the results are similar.</p>
<p>Note that the environment operations are themselves slightly faster than the fastmap operations, but the penalty is in slower garbage collection when many keys have been used. Also keep in mind that these tests are very artificial and use tens of thousands of random keys; if your application does not do this, then fastmap may have no practical benefit. In general, these operations are so fast that performance bottlenecks almost always lie elsewhere.</p>
</div>
<div id="testing-your-code-for-symbol-leakage" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-your-code-for-symbol-leakage" class="anchor"></a>Testing your code for symbol leakage</h2>
<p>If you want to test your code directly for symbol leakage, you can use the code below.</p>
<p>The <code>get_symbols()</code> function returns all symbols that are registered in R’s symbol table.</p>
<p><code>new_symbols()</code> returns all symbols that have been added since the last time <code>new_symbols()</code> was run. If you want to test whether your code causes the symbol table to grow, run <code>new_symbols()</code>, then run your code, then run <code>new_symbols()</code> again.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">get_symbols &lt;-<span class="st"> </span>inline<span class="op">::</span><span class="kw">cfunction</span>(</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  <span class="dt">includes =</span> <span class="st">"</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="st">    #define HSIZE   49157 /* The size of the hash table for symbols, from Defn.h */</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="st">    extern SEXP* R_SymbolTable;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="st">  "</span>,</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="dt">body =</span> <span class="st">"</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="st">    int symbol_count = 0;</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="st">    SEXP s;</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="st">    int j;</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="st">    for (j = 0; j &lt; HSIZE; j++) {</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="st">      for (s = R_SymbolTable[j]; s != R_NilValue; s = CDR(s)) {</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="st">        if (CAR(s) != R_NilValue) {</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="st">          symbol_count++;</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="st">        }</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="st">      }</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="st">    }</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="st">  </span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"><span class="st">  </span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="st">    SEXP result = PROTECT(Rf_allocVector(STRSXP, symbol_count));</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="st">    symbol_count = 0;</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="st">    for (j = 0; j &lt; HSIZE; j++) {</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="st">      for (s = R_SymbolTable[j]; s != R_NilValue; s = CDR(s)) {</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23"><span class="st">        if (CAR(s) != R_NilValue) {</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"><span class="st">          SET_STRING_ELT(result, symbol_count, PRINTNAME(CAR(s)));</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25"><span class="st">          symbol_count++;</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26"><span class="st">        }</span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27"><span class="st">      }</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28"><span class="st">    }</span></a>
<a class="sourceLine" id="cb9-29" data-line-number="29"><span class="st">  </span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30"><span class="st">    UNPROTECT(1);</span></a>
<a class="sourceLine" id="cb9-31" data-line-number="31"><span class="st">    return result;</span></a>
<a class="sourceLine" id="cb9-32" data-line-number="32"><span class="st">  "</span></a>
<a class="sourceLine" id="cb9-33" data-line-number="33">)</a>
<a class="sourceLine" id="cb9-34" data-line-number="34"></a>
<a class="sourceLine" id="cb9-35" data-line-number="35"><span class="co"># Test it out</span></a>
<a class="sourceLine" id="cb9-36" data-line-number="36"><span class="kw">get_symbols</span>()</a>
<a class="sourceLine" id="cb9-37" data-line-number="37"></a>
<a class="sourceLine" id="cb9-38" data-line-number="38"></a>
<a class="sourceLine" id="cb9-39" data-line-number="39"><span class="co"># new_symbols() returns a character vector of symbols that have been added since</span></a>
<a class="sourceLine" id="cb9-40" data-line-number="40"><span class="co"># the last time it was run.</span></a>
<a class="sourceLine" id="cb9-41" data-line-number="41">last_symbols &lt;-<span class="st"> </span><span class="kw">get_symbols</span>()</a>
<a class="sourceLine" id="cb9-42" data-line-number="42">new_symbols &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb9-43" data-line-number="43">  cur_symbols &lt;-<span class="st"> </span><span class="kw">get_symbols</span>()</a>
<a class="sourceLine" id="cb9-44" data-line-number="44">  res &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(cur_symbols, last_symbols)</a>
<a class="sourceLine" id="cb9-45" data-line-number="45">  last_symbols &lt;&lt;-<span class="st"> </span>cur_symbols</a>
<a class="sourceLine" id="cb9-46" data-line-number="46">  res</a>
<a class="sourceLine" id="cb9-47" data-line-number="47">}</a>
<a class="sourceLine" id="cb9-48" data-line-number="48"></a>
<a class="sourceLine" id="cb9-49" data-line-number="49"><span class="co"># Example</span></a>
<a class="sourceLine" id="cb9-50" data-line-number="50"></a>
<a class="sourceLine" id="cb9-51" data-line-number="51"><span class="co"># The first couple times it's run, R might do something that adds symbols, like</span></a>
<a class="sourceLine" id="cb9-52" data-line-number="52"><span class="co"># load the compiler package. Run it a bunch of times until it returns</span></a>
<a class="sourceLine" id="cb9-53" data-line-number="53"><span class="co"># character(0).</span></a>
<a class="sourceLine" id="cb9-54" data-line-number="54"><span class="kw">new_symbols</span>()</a>
<a class="sourceLine" id="cb9-55" data-line-number="55"><span class="kw">new_symbols</span>()</a>
<a class="sourceLine" id="cb9-56" data-line-number="56"><span class="kw">new_symbols</span>()</a>
<a class="sourceLine" id="cb9-57" data-line-number="57"><span class="co"># character(0)</span></a>
<a class="sourceLine" id="cb9-58" data-line-number="58"></a>
<a class="sourceLine" id="cb9-59" data-line-number="59"></a>
<a class="sourceLine" id="cb9-60" data-line-number="60"><span class="co"># After R stops loading things, run our code and see which new symbols have</span></a>
<a class="sourceLine" id="cb9-61" data-line-number="61"><span class="co"># been added.</span></a>
<a class="sourceLine" id="cb9-62" data-line-number="62">abcdefg &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb9-63" data-line-number="63"><span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(<span class="st">"xyz"</span>)</a>
<a class="sourceLine" id="cb9-64" data-line-number="64"><span class="kw">new_symbols</span>()</a>
<a class="sourceLine" id="cb9-65" data-line-number="65"><span class="co">#&gt; [1] "abcdefg" "xyz"</span></a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=fastmap">https://​cloud.r-project.org/​package=fastmap</a>
</li>
<li>Browse source code at <br><a href="https://github.com/r-lib/fastmap">https://​github.com/​r-lib/​fastmap</a>
</li>
<li>Report a bug at <br><a href="https://github.com/r-lib/fastmap/issues">https://​github.com/​r-lib/​fastmap/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Winston Chang <br><small class="roles"> Author, maintainer </small>  </li>
<li>
<a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a> <br><small class="roles"> Copyright holder, funder </small>  </li>
<li><a href="authors.html">All authors...</a></li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/r-lib/fastmap"><img src="https://travis-ci.org/r-lib/fastmap.svg?branch=master" alt="Travis build status"></a></li>
<li><a href="https://ci.appveyor.com/project/r-lib/fastmap"><img src="https://ci.appveyor.com/api/projects/status/github/r-lib/fastmap?branch=master&amp;svg=true" alt="AppVeyor build status"></a></li>
<li><a href="https://cran.r-project.org/package=fastmap"><img src="https://www.r-pkg.org/badges/version/fastmap" alt="CRAN status"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Winston Chang, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9100.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
